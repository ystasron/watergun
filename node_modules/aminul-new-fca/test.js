const login = require('./index');
const utils = require('./utils');

console.log("[ TEST ] Starting library validation...");

console.log("[ TEST ] Checking login export...");
if (typeof login !== 'function') {
  console.error("[ FAIL ] login is not a function");
  process.exit(1);
}
console.log("[ PASS ] login is a function");

console.log("[ TEST ] Checking login.utils...");
if (!login.utils) {
  console.error("[ FAIL ] login.utils is not defined");
  process.exit(1);
}
console.log("[ PASS ] login.utils exists");

console.log("[ TEST ] Checking rate limiter...");
if (!login.utils.rateLimiter) {
  console.error("[ FAIL ] rateLimiter not found");
  process.exit(1);
}
console.log("[ PASS ] rateLimiter exists");

console.log("[ TEST ] Checking connection monitor...");
if (!login.utils.connectionMonitor) {
  console.error("[ FAIL ] connectionMonitor not found");
  process.exit(1);
}
console.log("[ PASS ] connectionMonitor exists");

console.log("[ TEST ] Checking utils exports...");
const requiredUtils = [
  'isReadableStream', 'get', 'post', 'getType',
  'retryWithBackoff', 'isValidThreadID', 'isValidUserID',
  'sanitizeMessageBody', 'deepClone', 'debounce', 'throttle',
  'sleep', 'chunkArray', 'uniqueArray', 'formatDuration'
];

let missingUtils = [];
requiredUtils.forEach(name => {
  if (typeof utils[name] === 'undefined') {
    missingUtils.push(name);
  }
});

if (missingUtils.length > 0) {
  console.error("[ FAIL ] Missing utils:", missingUtils.join(', '));
  process.exit(1);
}
console.log("[ PASS ] All required utils exist");

console.log("[ TEST ] Testing utility functions...");

if (!utils.isValidThreadID("1234567890123")) {
  console.error("[ FAIL ] isValidThreadID failed");
  process.exit(1);
}
console.log("[ PASS ] isValidThreadID works");

if (utils.sanitizeMessageBody("  Hello  ") !== "Hello") {
  console.error("[ FAIL ] sanitizeMessageBody failed");
  process.exit(1);
}
console.log("[ PASS ] sanitizeMessageBody works");

const arr = [1, 2, 2, 3, 3, 3];
if (utils.uniqueArray(arr).length !== 3) {
  console.error("[ FAIL ] uniqueArray failed");
  process.exit(1);
}
console.log("[ PASS ] uniqueArray works");

const chunked = utils.chunkArray([1, 2, 3, 4, 5], 2);
if (chunked.length !== 3 || chunked[0].length !== 2) {
  console.error("[ FAIL ] chunkArray failed");
  process.exit(1);
}
console.log("[ PASS ] chunkArray works");

const duration = utils.formatDuration(3661000);
if (!duration.includes("h")) {
  console.error("[ FAIL ] formatDuration failed");
  process.exit(1);
}
console.log("[ PASS ] formatDuration works");

console.log("");
console.log("=================================");
console.log("[ SUCCESS ] All tests passed!");
console.log("=================================");
console.log("");
console.log("Library is ready for use.");
console.log("Version:", require('./package.json').version);
